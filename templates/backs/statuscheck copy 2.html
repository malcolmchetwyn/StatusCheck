<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Check</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2>Status Check for <span id="current-date"></span></h2>

        <!-- Progress Bar -->
        <div class="progress mb-4">
            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>

        <!-- Accordion for sections -->
        <div id="accordion">
            <!-- Wake Up Section -->
            <div class="card">
                <div class="card-header" id="headingWakeUp">
                    <h5 class="mb-0">
                        <button class="btn btn-link" data-toggle="collapse" data-target="#wakeUp" aria-expanded="true" aria-controls="wakeUp">
                            Wake Up
                        </button>
                    </h5>
                </div>
                <div id="wakeUp" class="collapse show" aria-labelledby="headingWakeUp" data-parent="#accordion">
                    <div class="card-body">
                        <div class="form-group">
                            <label for="wake_up_mental">Mental Status:</label>
                            <input type="text" id="wake_up_mental" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="wake_up_emotional">Emotional Status:</label>
                            <input type="text" id="wake_up_emotional" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="wake_up_physical">Physical Status:</label>
                            <input type="text" id="wake_up_physical" class="form-control">
                        </div>
                        <button class="btn btn-primary mt-3" onclick="submitSection('wakeUp')">Save</button>
                    </div>
                </div>
            </div>

            <!-- Post Breakfast Section -->
            <div class="card">
                <div class="card-header" id="headingPostBreakfast">
                    <h5 class="mb-0">
                        <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#postBreakfast" aria-expanded="false" aria-controls="postBreakfast">
                            Post Breakfast
                        </button>
                    </h5>
                </div>
                <div id="postBreakfast" class="collapse" aria-labelledby="headingPostBreakfast" data-parent="#accordion">
                    <div class="card-body">
                        <div class="form-group">
                            <label for="post_breakfast_mental">Mental Status:</label>
                            <input type="text" id="post_breakfast_mental" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="post_breakfast_emotional">Emotional Status:</label>
                            <input type="text" id="post_breakfast_emotional" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="post_breakfast_physical">Physical Status:</label>
                            <input type="text" id="post_breakfast_physical" class="form-control">
                        </div>
                        <button class="btn btn-primary mt-3" onclick="submitSection('postBreakfast')">Save</button>
                    </div>
                </div>
            </div>

            <!-- Post Lunch Section -->
            <div class="card">
                <div class="card-header" id="headingPostLunch">
                    <h5 class="mb-0">
                        <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#postLunch" aria-expanded="false" aria-controls="postLunch">
                            Post Lunch
                        </button>
                    </h5>
                </div>
                <div id="postLunch" class="collapse" aria-labelledby="headingPostLunch" data-parent="#accordion">
                    <div class="card-body">
                        <div class="form-group">
                            <label for="post_lunch_mental">Mental Status:</label>
                            <input type="text" id="post_lunch_mental" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="post_lunch_emotional">Emotional Status:</label>
                            <input type="text" id="post_lunch_emotional" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="post_lunch_physical">Physical Status:</label>
                            <input type="text" id="post_lunch_physical" class="form-control">
                        </div>
                        <button class="btn btn-primary mt-3" onclick="submitSection('postLunch')">Save</button>
                    </div>
                </div>
            </div>

            <!-- Post Dinner Section -->
            <div class="card">
                <div class="card-header" id="headingPostDinner">
                    <h5 class="mb-0">
                        <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#postDinner" aria-expanded="false" aria-controls="postDinner">
                            Post Dinner
                        </button>
                    </h5>
                </div>
                <div id="postDinner" class="collapse" aria-labelledby="headingPostDinner" data-parent="#accordion">
                    <div class="card-body">
                        <div class="form-group">
                            <label for="post_dinner_mental">Mental Status:</label>
                            <input type="text" id="post_dinner_mental" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="post_dinner_emotional">Emotional Status:</label>
                            <input type="text" id="post_dinner_emotional" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="post_dinner_physical">Physical Status:</label>
                            <input type="text" id="post_dinner_physical" class="form-control">
                        </div>
                        <button class="btn btn-primary mt-3" onclick="submitSection('postDinner')">Save</button>
                    </div>
                </div>
            </div>

            <!-- Bedtime Section -->
            <div class="card">
                <div class="card-header" id="headingBedtime">
                    <h5 class="mb-0">
                        <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#bedtime" aria-expanded="false" aria-controls="bedtime">
                            Bedtime
                        </button>
                    </h5>
                </div>
                <div id="bedtime" class="collapse" aria-labelledby="headingBedtime" data-parent="#accordion">
                    <div class="card-body">
                        <div class="form-group">
                            <label for="bedtime_mental">Mental Status:</label>
                            <input type="text" id="bedtime_mental" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="bedtime_emotional">Emotional Status:</label>
                            <input type="text" id="bedtime_emotional" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="bedtime_physical">Physical Status:</label>
                            <input type="text" id="bedtime_physical" class="form-control">
                        </div>
                        <button class="btn btn-primary mt-3" onclick="submitSection('bedtime')">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('current-date').innerText = today;

            // Fetch today's data from the backend
            fetch('/status/today')
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch today's data");
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Fetched today's data:", data); // Debugging line
                    if (Object.keys(data).length > 0) {
                        // Populate fields with today's data if available
                        document.getElementById('wake_up_mental').value = data.wake_up_mental || '';
                        document.getElementById('wake_up_emotional').value = data.wake_up_emotional || '';
                        document.getElementById('wake_up_physical').value = data.wake_up_physical || '';
                        document.getElementById('post_breakfast_mental').value = data.post_breakfast_mental || '';
                        document.getElementById('post_breakfast_emotional').value = data.post_breakfast_emotional || '';
                        document.getElementById('post_breakfast_physical').value = data.post_breakfast_physical || '';
                        document.getElementById('post_lunch_mental').value = data.post_lunch_mental || '';
                        document.getElementById('post_lunch_emotional').value = data.post_lunch_emotional || '';
                        document.getElementById('post_lunch_physical').value = data.post_lunch_physical || '';
                        document.getElementById('post_dinner_mental').value = data.post_dinner_mental || '';
                        document.getElementById('post_dinner_emotional').value = data.post_dinner_emotional || '';
                        document.getElementById('post_dinner_physical').value = data.post_dinner_physical || '';
                        document.getElementById('bedtime_mental').value = data.bedtime_mental || '';
                        document.getElementById('bedtime_emotional').value = data.bedtime_emotional || '';
                        document.getElementById('bedtime_physical').value = data.bedtime_physical || '';

                        // Update the progress bar based on existing data
                        updateProgressBarFromData(data); // Call the correct function
                    }
                })
                .catch(error => {
                    console.error('Error fetching today\'s data:', error);
                });
        });

        // Function to gather data from each section
        function gatherSectionData(sectionId) {
            const data = { date: new Date().toISOString().split('T')[0] };  // Include today's date
            switch (sectionId) {
                case 'wakeUp':
                    data.wake_up_mental = document.getElementById('wake_up_mental').value;
                    data.wake_up_emotional = document.getElementById('wake_up_emotional').value;
                    data.wake_up_physical = document.getElementById('wake_up_physical').value;
                    break;
                case 'postBreakfast':
                    data.post_breakfast_mental = document.getElementById('post_breakfast_mental').value;
                    data.post_breakfast_emotional = document.getElementById('post_breakfast_emotional').value;
                    data.post_breakfast_physical = document.getElementById('post_breakfast_physical').value;
                    break;
                case 'postLunch':
                    data.post_lunch_mental = document.getElementById('post_lunch_mental').value;
                    data.post_lunch_emotional = document.getElementById('post_lunch_emotional').value;
                    data.post_lunch_physical = document.getElementById('post_lunch_physical').value;
                    break;
                case 'postDinner':
                    data.post_dinner_mental = document.getElementById('post_dinner_mental').value;
                    data.post_dinner_emotional = document.getElementById('post_dinner_emotional').value;
                    data.post_dinner_physical = document.getElementById('post_dinner_physical').value;
                    break;
                case 'bedtime':
                    data.bedtime_mental = document.getElementById('bedtime_mental').value;
                    data.bedtime_emotional = document.getElementById('bedtime_emotional').value;
                    data.bedtime_physical = document.getElementById('bedtime_physical').value;
                    break;
                default:
                    return null;
            }

            console.log("Gathered data for section:", sectionId, data); // Debugging line

            // Validate fields (ensure all required fields are filled)
            for (const key in data) {
                if (data[key] === "") {
                    return null;  // Return null if any required field is empty
                }
            }

            return data;
        }

        // Function to submit data for each section via AJAX
        function submitSection(sectionId) {
            const sectionData = gatherSectionData(sectionId);  // Gather data from the section
            console.log("Section Data being submitted:", sectionData); // Debugging line

            if (!sectionData) {
                alert("Please fill in all required fields.");
                return;
            }

            fetch('/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(sectionData),  // Send data in JSON format
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                console.log("Response from server:", data); // Debugging line
                if (data.message) {
                    alert(`${sectionId} data saved successfully.`);
                    updateProgressBar();  // Update progress bar after saving
                } else {
                    alert('Failed to save the data.');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }

        // Function to update the progress bar based on saved sections
        function updateProgressBar() {
            // Fetch the latest data and update the progress bar accordingly
            fetch('/status/today')
                .then(response => response.json())
                .then(data => {
                    updateProgressBarFromData(data);
                });
        }

        // Function to update the progress bar based on existing data
        function updateProgressBarFromData(data) {
            let filledSections = 0;

            // Check each section for completed fields
            if (data.wake_up_mental && data.wake_up_emotional && data.wake_up_physical) filledSections++;
            if (data.post_breakfast_mental && data.post_breakfast_emotional && data.post_breakfast_physical) filledSections++;
            if (data.post_lunch_mental && data.post_lunch_emotional && data.post_lunch_physical) filledSections++;
            if (data.post_dinner_mental && data.post_dinner_emotional && data.post_dinner_physical) filledSections++;
            if (data.bedtime_mental && data.bedtime_emotional && data.bedtime_physical) filledSections++;

            // Update the progress bar
            const progressBar = document.getElementById('progress-bar');
            const newWidth = (filledSections / 5) * 100;  // Assuming 5 sections total
            progressBar.style.width = `${newWidth}%`;
        }
    </script>
</body>
</html>
